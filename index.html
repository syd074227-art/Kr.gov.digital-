<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تفعيل الهوية الرقمي - KR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #1a237e;
            --primary-dark: #0d1557;
            --primary-light: #3f51b5;
            --accent: #ff6f00;
            --accent-dark: #e65100;
            --accent-light: #ff9800;
            --health: #2196f3;
            --health-dark: #1976d2;
            --interior: #f44336;
            --interior-dark: #d32f2f;
            --justice: #4caf50;
            --justice-dark: #388e3c;
            --success: #00c853;
            --warning: #ffd600;
            --danger: #d50000;
            --info: #2196f3;
            --dark: #0d1117;
            --dark-card: #161b22;
            --light: #ffffff;
            --gray: #8b949e;
            --gray-light: #c9d1d9;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-dark: rgba(0, 0, 0, 0.3);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%);
            --gradient-accent: linear-gradient(135deg, #ff6f00 0%, #ff9800 100%);
            --gradient-health: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --gradient-interior: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            --gradient-justice: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            --gradient-dark: linear-gradient(135deg, #0d1117 0%, #1a237e 50%, #0d1117 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Cairo', 'Tajawal', sans-serif; }
        body { background: var(--gradient-dark); min-height: 100vh; color: var(--light); display: flex; justify-content: center; align-items: center; padding: 20px; overflow-x: hidden; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(33, 150, 243, 0.08) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(244, 67, 54, 0.08) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(76, 175, 80, 0.08) 0%, transparent 50%); pointer-events: none; z-index: 0; }

        /* شاشة التحميل */
        .loading-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--gradient-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 80px; height: 80px; border: 5px solid rgba(255, 111, 0, 0.2); border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: var(--accent); font-size: 18px; font-weight: 700; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .container { width: 100%; max-width: 1200px; background: var(--glass-dark); backdrop-filter: blur(20px); border-radius: 24px; overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow-lg); animation: containerAppear 1s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: 1; }
        @keyframes containerAppear { from { opacity: 0; transform: translateY(50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .header { background: var(--gradient-primary); color: white; padding: 50px 30px; text-align: center; position: relative; overflow: hidden; border-bottom: 4px solid var(--accent); }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 30%, rgba(255, 111, 0, 0.1) 50%, transparent 70%); animation: headerShine 8s infinite linear; }
        @keyframes headerShine { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .logo-container { position: relative; z-index: 1; }
        .logo-icon { width: 100px; height: 100px; margin: 0 auto 25px; background: var(--gradient-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: logoFloat 6s ease-in-out infinite; box-shadow: 0 15px 40px rgba(255, 111, 0, 0.4); }
        .logo-icon i { font-size: 48px; color: white; }
        @keyframes logoFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(5deg); } }
        .logo h1 { font-size: 38px; font-weight: 800; margin: 0 0 15px 0; background: linear-gradient(135deg, #fff 0%, var(--accent-light) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }
        .logo p { font-size: 16px; color: rgba(255, 255, 255, 0.9); font-weight: 500; }
        .kr-badge { position: absolute; top: 25px; left: 25px; background: var(--gradient-accent); color: white; padding: 10px 24px; border-radius: 50px; font-weight: 700; font-size: 14px; animation: badgePulse 3s infinite; box-shadow: 0 4px 15px rgba(255, 111, 0, 0.3); letter-spacing: 1px; }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 111, 0, 0.3); } 50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255, 111, 0, 0.5); } }
        .content { padding: 50px 40px; }
        .step { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 24px; padding: 45px; margin-bottom: 30px; animation: stepAppear 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; opacity: 0; transform: translateY(30px); }
        .step:nth-child(1) { animation-delay: 0.1s; }
        .step:nth-child(2) { animation-delay: 0.2s; }
        .step:nth-child(3) { animation-delay: 0.3s; }
        .step:nth-child(4) { animation-delay: 0.4s; }
        .step:nth-child(5) { animation-delay: 0.5s; }
        @keyframes stepAppear { to { opacity: 1; transform: translateY(0); } }
        .step-title { color: var(--accent-light); margin-bottom: 40px; display: flex; align-items: center; gap: 20px; font-size: 28px; font-weight: 700; }
        .step-number { width: 65px; height: 65px; background: var(--gradient-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 26px; color: white; animation: numberGlow 3s infinite; box-shadow: 0 8px 25px rgba(255, 111, 0, 0.4); }
        @keyframes numberGlow { 0%, 100% { box-shadow: 0 8px 25px rgba(255, 111, 0, 0.3); } 50% { box-shadow: 0 12px 35px rgba(255, 111, 0, 0.5); } }
        .input-group { margin-bottom: 30px; position: relative; }
        .input-group label { display: block; margin-bottom: 14px; color: rgba(255, 255, 255, 0.95); font-weight: 600; font-size: 17px; display: flex; align-items: center; gap: 12px; }
        .input-group label i { color: var(--accent); font-size: 20px; width: 24px; text-align: center; }
        .input-group input { width: 100%; padding: 20px 24px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 14px; color: white; font-size: 17px; transition: all 0.3s ease; outline: none; }
        .input-group input::placeholder { color: rgba(255, 255, 255, 0.4); }
        .input-group input:focus { border-color: var(--accent); background: rgba(0, 0, 0, 0.4); box-shadow: 0 0 0 4px rgba(255, 111, 0, 0.15); transform: translateY(-2px); }
        .char-counter { position: absolute; left: 20px; bottom: 24px; font-size: 13px; color: rgba(255, 255, 255, 0.5); background: rgba(0, 0, 0, 0.4); padding: 6px 14px; border-radius: 20px; font-weight: 600; transition: all 0.3s; }
        .departments-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; margin: 35px 0; max-width: 800px; margin-left: auto; margin-right: auto; }
        .department-card { background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.08); border-radius: 18px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; backdrop-filter: blur(10px); }
        .department-card.selected { border-color: var(--accent); background: rgba(255, 111, 0, 0.08); transform: translateY(-5px); box-shadow: 0 15px 40px rgba(255, 111, 0, 0.25); }
        .department-card.selected::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 12px; right: 12px; background: var(--accent); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; animation: checkAppear 0.3s ease; box-shadow: 0 4px 12px rgba(255, 111, 0, 0.4); }
        @keyframes checkAppear { from { transform: scale(0) rotate(-180deg); } to { transform: scale(1) rotate(0deg); } }
        .department-icon { width: 75px; height: 75px; margin: 0 auto 20px; border-radius: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; }
        .department-icon i { font-size: 36px; color: white; }
        .health .department-icon { background: var(--gradient-health); }
        .interior .department-icon { background: var(--gradient-interior); }
        .justice .department-icon { background: var(--gradient-justice); }
        .citizen .department-icon { background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); }
        .department-card h4 { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--light); }
        .department-card small { font-size: 13px; color: var(--gray-light); font-weight: 500; display: block; line-height: 1.4; }
        .ranks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 18px; margin-top: 30px; max-height: 550px; overflow-y: auto; padding: 15px; background: rgba(0, 0, 0, 0.1); border-radius: 16px; }
        .rank-item { background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 14px; padding: 22px 18px; text-align: center; cursor: pointer; transition: all 0.3s ease; color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 15px; position: relative; }
        .rank-item.selected { background: linear-gradient(135deg, rgba(255, 111, 0, 0.25), rgba(26, 35, 126, 0.3)); border-color: var(--accent); color: white; font-weight: 700; transform: translateY(-4px); }
        .rank-item.selected::before { content: '\f005'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 8px; right: 8px; color: var(--accent); font-size: 14px; }
        .additionals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 22px; margin: 35px 0; }
        .additional-item { background: rgba(0, 0, 0, 0.25); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 28px 24px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .additional-item.selected { background: linear-gradient(135deg, rgba(255, 111, 0, 0.15), rgba(26, 35, 126, 0.25)); border-color: var(--accent); transform: translateY(-5px); }
        .btn { background: var(--gradient-accent); color: white; border: none; padding: 22px 45px; border-radius: 16px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.4s ease; display: flex; align-items: center; justify-content: center; gap: 15px; width: 100%; margin-top: 35px; animation: btnGlow 3s infinite; letter-spacing: 0.5px; }
        @keyframes btnGlow { 0%, 100% { box-shadow: 0 10px 35px rgba(255, 111, 0, 0.35); } 50% { box-shadow: 0 15px 45px rgba(255, 111, 0, 0.5); } }
        .btn-secondary { background: rgba(255, 255, 255, 0.08); color: white; border: 2px solid rgba(255, 255, 255, 0.2); animation: none; box-shadow: none; }
        .btn-group { display: flex; gap: 25px; margin-top: 40px; }
        .btn-group .btn { flex: 1; margin-top: 0; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 22px; margin: 35px 0; }
        .summary-item { background: rgba(0, 0, 0, 0.3); padding: 25px; border-radius: 18px; border-left: 5px solid var(--accent); transition: all 0.3s ease; }
        .summary-item .label { color: rgba(255, 255, 255, 0.65); font-size: 14px; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
        .summary-item .value { color: white; font-size: 19px; font-weight: 700; }
        .status-message, .alert, .success-message { display: none; padding: 35px; border-radius: 20px; margin-bottom: 30px; text-align: center; animation: messageAppear 0.5s ease; border: 2px solid transparent; }
        .status-message.show, .alert.show, .success-message.show { display: block; }
        .alert.warning { background: linear-gradient(135deg, rgba(255, 214, 0, 0.15), rgba(255, 193, 7, 0.15)); border-color: var(--warning); color: var(--warning); }
        .success-message { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .terms-container { background: rgba(255, 111, 0, 0.06); border-radius: 18px; padding: 30px; margin: 35px 0; border: 1px solid rgba(255, 111, 0, 0.2); }
        .term-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 18px; padding: 18px; background: rgba(0, 0, 0, 0.25); border-radius: 12px; }
        .file-upload-label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 30px; background: rgba(0, 0, 0, 0.2); border: 2px dashed rgba(255, 255, 255, 0.2); border-radius: 16px; cursor: pointer; text-align: center; }
        .image-preview { display: none; margin-top: 20px; position: relative; }
        .image-preview.show { display: block; }
        .image-preview img { width: 100%; max-width: 500px; border-radius: 16px; border: 3px solid var(--accent); }
        @media (max-width: 768px) { .container { max-width: 95%; } .departments-grid { grid-template-columns: 1fr; } .btn-group { flex-direction: column; } }
    </style>
</head>
<body>

    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">جاري الاتصال بالخادم...</div>
    </div>

    <div class="container">
        <div class="header">
            <div class="kr-badge"><i class="fas fa-crown"></i> KR OFFICIAL</div>
            <div class="logo-container">
                <div class="logo">
                    <div class="logo-icon"><i class="fas fa-id-card"></i></div>
                    <h1>نظام تفعيل الهوية الرقمي</h1>
                    <p><i class="fas fa-shield-alt"></i> الجهة الرقمية المسؤولة - KR</p>
                </div>
            </div>
        </div>

        <div class="content">
            <div id="previousRequestMessage" class="status-message"></div>
            <div class="alert" id="alertBox"></div>
            
            <div id="applicationForm" style="display: none;">
                <div class="step" id="step1">
                    <div class="step-title"><div class="step-number">1</div><span>البيانات الأساسية</span></div>
                    <div class="input-group"><label><i class="fas fa-user"></i> الاسم الكامل ثلاثي</label><input type="text" id="fullName" placeholder="محمد بن فهد الحربي"></div>
                    <div class="input-group"><label><i class="fas fa-calendar-alt"></i> العمر</label><input type="number" id="age" placeholder="أدخل عمرك"></div>
                    <div class="input-group"><label><i class="fas fa-gamepad"></i> اسم المستخدم في اللعبة</label><input type="text" id="gameUsername" placeholder="Ahmed_KR" dir="ltr"></div>
                    <div class="input-group"><label><i class="fab fa-discord"></i> اسم المستخدم في الديسكورد</label><input type="text" id="discordUsername" placeholder="Ahmed#1234" dir="ltr"></div>
                    <div class="input-group">
                        <label><i class="fas fa-fingerprint"></i> رقم الهوية في اللعبة</label>
                        <input type="text" id="gameId" placeholder="أدخل 10 أرقام" maxlength="10" dir="ltr" oninput="validateGameId(this)">
                        <div class="char-counter" id="gameIdCounter">0/10</div>
                    </div>
                    
                    <div class="input-group">
                        <label><i class="fas fa-id-card"></i> إرفاق الهوية الوطنية داخل اللعبة</label>
                        <input type="file" id="nationalIdImage" accept="image/*" onchange="handleImageUpload(this, 'nationalIdPreview')" style="display: none;">
                        <label for="nationalIdImage" class="file-upload-label"><i class="fas fa-cloud-upload-alt"></i><span>اختر الصورة</span></label>
                        <div id="nationalIdPreview" class="image-preview"></div>
                    </div>
                    <div class="input-group">
                        <label><i class="fas fa-camera"></i> تصوير شخصيتك داخل اللعبة</label>
                        <input type="file" id="characterImage" accept="image/*" onchange="handleImageUpload(this, 'characterPreview')" style="display: none;">
                        <label for="characterImage" class="file-upload-label"><i class="fas fa-cloud-upload-alt"></i><span>اختر الصورة</span></label>
                        <div id="characterPreview" class="image-preview"></div>
                    </div>
                    <button class="btn" onclick="validateStep1()">التالي <i class="fas fa-arrow-left"></i></button>
                </div>

                <div class="step" id="step2" style="display: none;">
                    <div class="step-title"><div class="step-number">2</div><span>اختر التصنيف</span></div>
                    <div class="departments-grid">
                        <div class="department-card health" onclick="selectDepartment(this, 'health')"><div class="department-icon"><i class="fas fa-heartbeat"></i></div><h4>وزارة الصحة</h4></div>
                        <div class="department-card interior" onclick="selectDepartment(this, 'interior')"><div class="department-icon"><i class="fas fa-shield-alt"></i></div><h4>وزارة الداخلية</h4></div>
                        <div class="department-card justice" onclick="selectDepartment(this, 'justice')"><div class="department-icon"><i class="fas fa-gavel"></i></div><h4>وزارة العدل</h4></div>
                        <div class="department-card citizen" onclick="selectDepartment(this, 'citizen')"><div class="department-icon"><i class="fas fa-user"></i></div><h4>مواطن</h4></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goBackToStep1()"><i class="fas fa-arrow-right"></i> السابق</button>
                        <button class="btn" onclick="showStep3()">التالي <i class="fas fa-arrow-left"></i></button>
                    </div>
                </div>

                <div class="step" id="step3" style="display: none;">
                    <div class="step-title"><div class="step-number">3</div><span>اختيار الرتبة</span></div>
                    <div id="ranksContainer"></div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goBackToStep2()">السابق</button>
                        <button class="btn" onclick="showStep4()">التالي</button>
                    </div>
                </div>

                <div class="step" id="step4" style="display: none;">
                    <div class="step-title"><div class="step-number">4</div><span>المناصب الإدارية</span></div>
                    <div id="additionalContainer"></div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goBackToStep3()">السابق</button>
                        <button class="btn" onclick="showStep5()">التالي</button>
                    </div>
                </div>

                <div class="step" id="step5" style="display: none;">
                    <div class="step-title"><div class="step-number">5</div><span>تأكيد وإرسال الطلب</span></div>
                    <div class="summary-grid" id="requestSummary"></div>
                    <div class="terms-container">
                        <div class="term-item"><input type="checkbox" id="agreeTerms1"><label for="agreeTerms1">أوافق على صحة المعلومات</label></div>
                        <div class="term-item"><input type="checkbox" id="agreeTerms2"><label for="agreeTerms2">أوافق على أنظمة KR</label></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goBackToStep4()">السابق</button>
                        <button class="btn" onclick="submitToFirebase()"><i class="fas fa-paper-plane"></i> إرسال الطلب سحابياً</button>
                    </div>
                </div>
            </div>

            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle" style="font-size: 80px; color: var(--success);"></i>
                <h2>تم إرسال طلبك للسحابة!</h2>
                <div id="successDetails"></div>
            </div>
        </div>
    </div>

<script>
    // 1. إعدادات Firebase (KR System)
    const firebaseConfig = {
        apiKey: "AIzaSyB68LMIIbyS86NgXYMR6ramIayZvKx1yxo",
        authDomain: "kr-system-5c846.firebaseapp.com",
        databaseURL: "https://kr-system-5c846-default-rtdb.firebaseio.com",
        projectId: "kr-system-5c846",
        storageBucket: "kr-system-5c846.firebasestorage.app",
        appId: "1:676032414707:web:f2f535b87522b2402f4886"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const DEPARTMENTS = {
        health: { name: 'وزارة الصحة', color: '#2196f3', ranks: ['مسعف', 'ممرض', 'دكتور', 'وزير الصحة'], additionals: ['إدارة القبول', 'الشؤون الصحية'] },
        interior: { name: 'وزارة الداخلية', color: '#f44336', ranks: ['جندي', 'رقيب', 'ملازم', 'لواء', 'وزير الداخلية'], additionals: ['القبول والتسجيل', 'شؤون الأفراد'] },
        justice: { name: 'وزارة العدل', color: '#4caf50', ranks: ['محامي', 'قاضي', 'وزير العدل'], additionals: ['الشؤون العدلية'] },
        citizen: { name: 'مواطن', color: '#9c27b0', ranks: ['مواطن'], additionals: [] }
    };

    let selectedDept = null;
    let selectedRank = null;
    let selectedAdditionals = [];
    let uploadedNationalId = null;
    let uploadedCharacterImage = null;
    const deviceId = localStorage.getItem('kr_device_id') || 'dev_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('kr_device_id', deviceId);

    // 2. التحقق من حالة الطلب عند الفتح
    window.onload = function() {
        database.ref('requests').orderByChild('deviceId').equalTo(deviceId).on('value', snapshot => {
            document.getElementById('loadingScreen').style.display = 'none';
            if (snapshot.exists()) {
                const data = snapshot.val();
                const id = Object.keys(data)[0];
                const request = data[id];
                showStatus(request);
            } else {
                document.getElementById('applicationForm').style.display = 'block';
            }
        });
    };

    function validateStep1() {
        if (!document.getElementById('fullName').value || !document.getElementById('gameId').value || !uploadedNationalId || !uploadedCharacterImage) {
            alert("يرجى إكمال البيانات ورفع الصور المطلوبة"); return;
        }
        showStep(2);
    }

    function selectDepartment(el, dept) {
        selectedDept = dept;
        document.querySelectorAll('.department-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }

    function showStep3() {
        if (!selectedDept) return;
        const container = document.getElementById('ranksContainer');
        container.innerHTML = `<div class="ranks-grid">${DEPARTMENTS[selectedDept].ranks.map(r => `<div class="rank-item" onclick="selectRank(this, '${r}')">${r}</div>`).join('')}</div>`;
        showStep(3);
    }

    function selectRank(el, rank) {
        selectedRank = rank;
        document.querySelectorAll('.rank-item').forEach(r => r.classList.remove('selected'));
        el.classList.add('selected');
    }

    function showStep4() { showStep(4); /* عرض المناصب بنفس الطريقة */ }
    function showStep5() { showStep(5); }

    function showStep(n) {
        document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
        document.getElementById('step' + n).style.display = 'block';
    }

    function handleImageUpload(input, previewId) {
        const reader = new FileReader();
        reader.onload = (e) => {
            if (previewId === 'nationalIdPreview') uploadedNationalId = e.target.result;
            else uploadedCharacterImage = e.target.result;
            document.getElementById(previewId).innerHTML = `<img src="${e.target.result}" style="width:100%">`;
            document.getElementById(previewId).classList.add('show');
        };
        reader.readAsDataURL(input.files[0]);
    }

    // 3. الإرسال إلى Firebase
    function submitToFirebase() {
        if (!document.getElementById('agreeTerms1').checked) return;
        
        const requestData = {
            fullName: document.getElementById('fullName').value,
            gameId: document.getElementById('gameId').value,
            gameUsername: document.getElementById('gameUsername').value,
            discordUsername: document.getElementById('discordUsername').value,
            department: DEPARTMENTS[selectedDept].name,
            rank: selectedRank,
            status: 'pending',
            deviceId: deviceId,
            timestamp: Date.now()
        };

        database.ref('requests').push(requestData).then(() => {
            alert("تم الإرسال بنجاح!");
        });
    }

    function showStatus(req) {
        const msg = document.getElementById('previousRequestMessage');
        document.getElementById('applicationForm').style.display = 'none';
        msg.classList.add('show');
        msg.innerHTML = `<h2>حالة طلبك: ${req.status === 'pending' ? 'قيد المراجعة ⏳' : req.status === 'accepted' ? 'تم القبول ✅' : 'مرفوض ❌'}</h2>`;
        if (req.status === 'accepted') setTimeout(() => window.location.href = "kr-digital-platform.html", 2000);
    }

    function validateGameId(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
        document.getElementById('gameIdCounter').innerText = `${input.value.length}/10`;
    }
    
    function goBackToStep1() { showStep(1); }
    function goBackToStep2() { showStep(2); }
    function goBackToStep3() { showStep(3); }
    function goBackToStep4() { showStep(4); }
</script>

</body>
</html>
